---
#
# Tasks and roles for all hosts
#
- hosts: fleet
  gather_facts: no

  pre_tasks:
    - import_tasks: tasks/ssh_juggle_port.yml
      tags:
        - port

- hosts: fleet
  become: yes
  roles:

    #
    # Basics
    #
    - role: system
      tags:
        - system

    - role: docker
      tags:
        - docker

    - role: chriswayg.msmtp-mailer
      tags:
        - msmtp

    - role: oefenweb.dns
      tags:
        - dns

    - role: geerlingguy.ntp
      tags:
        - ntp


    #
    # Security
    #
    - role: security/fail2ban
      tags:
      - fail2ban

    - role: security/iptables
      tags:
      - iptables
      when: enable_iptables

    - role: security/crowdsec
      tags:
      - crowdsec
      when: enable_crowdsec

    - role: security/endlessh
      tags:
      - endlessh
      when: enable_endlessh | default(False)

    - role: geerlingguy.security
      tags:
        - security

    #
    # Network
    #
    - role: network/bunkerized-nginx
      become: no
      tags:
        - bunkerized-nginx
        - containers
      when: enable_bunkerized_nginx | default(False)

    - role: network/swag
      become: no
      tags:
        - swag
        - containers
      when: enable_swag | default(False)

    - role: network/traefik
      become: no
      tags:
        - traefik
        - containers
      when: enable_traefik | default(False)

    - role: network/wireguard
      become: no
      tags:
        - wireguard
        - containers
      when: enable_wireguard | default(False)

    - role: network/tailscale
      become: no
      tags:
        - tailscale
        - containers
      when: enable_tailscale | default(False)

    - role: network/ikev2
      become: no
      tags:
        - ikev2
        - containers
      when: enable_ikev2 | default(False)

    - role: network/ddclient
      become: yes
      when: enable_ddclient | default(False)
      tags:
        - ddclient

    - role: network/duckdns
      become: no
      when: enable_duckdns | default(False)
      tags:
        - duckdns

    - role: network/cloudflare-ddns
      become: no
      tags:
        - cloudflare-ddns
        - containers
      when: enable_cloudflare_ddns | default(False)

    - role: network/pihole
      become: no
      when: enable_pihole | default(False)
      tags:
        - pihole
        - containers

    - role: network/ikev2
      become: no
      when: enable_ikev2 | default(False)
      tags:
        - containers
        - ikev2


    #
    # Filesystems
    #
    - role: filesystems/mergerfs
      become: yes
      tags:
        - mergerfs
      when: enable_nas_stuff | default(False)

    - role: filesystems/mounts
      become: yes
      tags:
        - mounts
      when: enable_nas_stuff | default(False)

    - role: filesystems/hd-idle
      become: yes
      tags:
        - hd-idle
      when: enable_nas_stuff | default(False)

    - role: stuvusit.smartd
      become: yes
      tags:
        - smartd
      when: enable_nas_stuff | default(False)

    - role: ironicbadger.snapraid
      become: yes
      tags:
        - snapraid
      when: enable_nas_stuff | default(False)

    #
    # Homer
    #
    - role: homer
      become: no
      tags:
        - homer
        - containers
      when: enable_homer | default(False)

    #
    # Services
    #
    - role: containers/system/jackett
      become: no
      tags:
        - jackett
        - containers
      when: enable_jackett | default(False)

    - role: containers/system/authelia
      become: no
      tags:
        - authelia
        - containers
      when: enable_authelia | default(False)

    - role: containers/system/watchtower
      become: no
      tags:
        - watchtower
        - containers

    - role: containers/system/unifi
      become: no
      tags:
        - unifi
        - containers
      when: enable_unifi | default(False)

    - role: containers/services/quotes_api
      become: no
      tags:
        - quotes
        - containers
      when: enable_quotes_api | default(False)

    #
    # System
    #
    - role: containers/system/netdata
      become: no
      tags:
        - netdata
        - containers
      when: enable_netdata | default(False)

    - role: containers/system/prometheus
      become: no
      tags:
        - prometheus
        - containers
      when: enable_prometheus | default(False)

    - role: containers/system/scrutiny
      become: no
      tags:
        - scrutiny
        - containers
      when: enable_scrutiny | default(False)

    #
    # Media
    #
    - role: containers/media/deluge
      become: no
      tags:
        - deluge
        - containers
      when: enable_deluge | default(False)

    - role: containers/media/sonarr
      become: no
      tags:
        - sonarr
        - containers
      when: enable_sonarr | default(False)

    - role: containers/media/radarr
      become: no
      tags:
        - radarr
        - containers
      when: enable_radarr | default(False)

    - role: containers/media/booksonic
      become: no
      tags:
        - booksonic
        - containers
      when: enable_booksonic | default(False)

    - role: containers/media/plex
      become: no
      tags:
        - plex
        - containers
      when: enable_plex | default(False)

    - role: containers/media/jellyfin
      become: no
      tags:
        - jellyfin
        - containers
      when: enable_jellyfin | default(False)

    - role: containers/media/openbooks
      become: no
      tags:
        - openbooks
        - containers
      when: enable_openbooks | default(False)

    #
    # Services
    #
    - role: containers/services/photoprism
      become: no
      tags:
        - photoprism
        - containers
      when: enable_photoprism | default(False)

    - role: containers/services/nextcloud
      become: no
      tags:
        - nextcloud
        - containers
      when: enable_nextcloud | default(False)

    - role: containers/services/vaultwarden
      become: no
      tags:
        - vaultwarden
        - containers
      when: enable_vaultwarden | default(False)

    - role: containers/services/seafile
      become: no
      tags:
        - seafile
        - containers
      when: enable_seafile | default(False)

    - role: containers/services/gitea
      become: no
      tags:
        - gitea
        - containers
      when: enable_gitea | default(False)

    - role: containers/services/minio
      become: no
      tags:
        - minio
        - containers
      when: enable_minio | default(False)

    - role: containers/services/rustpad
      become: no
      tags:
        - rustpad
        - containers
      when: enable_rustpad | default(False)

    - role: containers/services/etherpad
      become: no
      tags:
        - etherpad
        - containers
      when: enable_etherpad | default(False)

    - role: containers/services/coder
      become: no
      tags:
        - coder
        - containers
      when: enable_coder | default(False)
    
    - role: containers/services/syncthing
      become: no
      tags:
        - syncthing
        - containers
      when: enable_syncthing | default(False)

    #
    # Home automation
    #
    - role: containers/homeautomation/deconz
      become: no
      tags:
        - deconz
        - smarthome
        - containers
      when: enable_deconz | default(False)

    - role: containers/homeautomation/homeassistant
      become: no
      tags:
        - homeassistant
        - smarthome
        - containers
      when: enable_homeassistant | default(False)

    #
    # Samba
    #
    - role: bertvv.samba
      become: yes
      tags:
        - samba
      when: enable_nas_stuff | default(False)
